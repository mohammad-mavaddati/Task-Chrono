<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Task Chrono Infinity V8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;300;400;700;900&display=swap" rel="stylesheet">
    <!-- Libraries for Zip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Vazirmatn', 'sans-serif'] },
                    colors: { gray: { 850: '#1f2937', 900: '#111827', 950: '#030712' } }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; user-select: none; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        
        .glass-panel { background: rgba(31, 41, 55, 0.8); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(75, 85, 99, 0.6); }
        
        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } 
        }

        input[type=range] { -webkit-appearance: none; background: transparent; height: 4px; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #4b5563; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #60a5fa; margin-top: -4px; transition: transform 0.1s; }

        /* --- NEW DYNAMIC HEIGHT LOGIC --- */
        .recorder-wrapper {
            background: #273344; /* bg-gray-800/50 */
            border: 1px solid #374151; /* border-gray-700 */
            border-radius: 0.75rem; /* rounded-xl */
            margin-bottom: 1.5rem; /* mb-6 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
            overflow: hidden; /* Vital for max-height */
            transition: background-color 0.3s ease;
        }

        .input-mode {
            width: 100%;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out 0.1s, padding 0.3s ease;
        }

        /* Hidden state */
        .input-mode.hidden-mode {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            visibility: hidden;
        }

        /* Visible state */
        .input-mode.visible-mode {
            max-height: 500px; /* Large enough to fit any content */
            opacity: 1;
            padding: 0.75rem; /* p-3 */
            visibility: visible;
        }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col pb-20 sm:pb-0 bg-gray-950">

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full shadow-2xl border border-gray-700 transform -translate-y-24 transition-transform duration-300 z-[100] flex items-center gap-2 text-sm">
        <i class="fas fa-info-circle text-blue-400"></i> <span id="toast-msg"></span>
    </div>

    <div class="max-w-md w-full mx-auto h-screen flex flex-col bg-gray-900 sm:border-x sm:border-gray-800 shadow-2xl relative">
        
        <!-- Header -->
        <header class="glass-panel z-20 shrink-0">
            <div class="p-4 flex justify-between items-center">
                <h1 class="text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300 flex items-center gap-2">
                    <i class="fas fa-infinity text-blue-500"></i> Chrono Infinity
                </h1>
                <div class="flex gap-2">
                    <button onclick="backupManager.exportZip()" class="w-8 h-8 rounded-full bg-gray-800 border border-gray-600 flex items-center justify-center hover:bg-gray-700 text-green-400 transition-colors" title="پشتیبان‌گیری کامل (ZIP)">
                        <i class="fas fa-file-archive"></i>
                    </button>
                    <label class="w-8 h-8 rounded-full bg-gray-800 border border-gray-600 flex items-center justify-center hover:bg-gray-700 text-yellow-400 cursor-pointer transition-colors" title="بازیابی">
                        <i class="fas fa-upload"></i>
                        <input type="file" class="hidden" accept=".zip" onchange="backupManager.importZip(this)">
                    </label>
                </div>
            </div>
            
            <!-- Tabs (Removed) -->
            <div class="flex text-sm font-medium text-center text-gray-400">
                <div class="flex-1 p-3 text-gray-200 font-bold">تایم‌لاین</div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto relative no-scrollbar scroll-smooth">
            
            <!-- Tab: Timeline -->
            <div id="view-timeline" class="p-4 pb-24">
                
                <!-- Dynamic Input Area -->
                <div class="recorder-wrapper">
                    
                    <!-- Mode 1: Standard Text Input -->
                    <div id="input-standard" class="flex flex-col gap-3 input-mode visible-mode">
                        
                        <!-- UPDATED: Title Input -->
                        <input type="text" id="task-input" class="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-3 py-2.5 text-sm focus:border-blue-500 outline-none text-white placeholder-gray-500" placeholder="عنوان (الزامی)">
                        
                        <!-- NEW: Subject Input for Text -->
                        <textarea id="subject-input" rows="3" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-blue-500 outline-none text-white placeholder-gray-500" placeholder="موضوع (اختیاری)"></textarea>

                        <div class="flex justify-between items-center">
                            <div class="flex gap-2">
                                <select id="cat-input" class="bg-gray-900 border border-gray-700 rounded-lg px-2 py-1.5 text-xs text-gray-300 outline-none">
                                    <option value="work">کار</option>
                                    <option value="study">یادگیری</option>
                                    <option value="break">استراحت</option>
                                    <option value="sport">ورزش</option>
                                </select>
                                <button onclick="recorder.initUI()" class="w-8 h-8 rounded-full bg-gray-700 hover:bg-red-900/30 text-red-400 flex items-center justify-center transition-colors" title="شروع ضبط">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                            <button onclick="data.addLog('text')" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-1.5 rounded-lg text-sm font-bold shadow-lg shadow-blue-900/20 transition-colors">
                                ثبت
                            </button>
                        </div>
                    </div>

                    <!-- Mode 2: Recording Interface -->
                    <div id="input-recording" class="flex flex-col input-mode hidden-mode">
                        
                        <!-- Phase A: Active Recording -->
                        <div id="rec-phase-active" class="flex flex-col items-center justify-center w-full py-2">
                            <div class="flex items-center gap-6 mb-3">
                                <button onclick="recorder.stop()" class="w-16 h-16 rounded-full bg-red-600 text-white flex items-center justify-center recording-pulse shadow-2xl">
                                    <i class="fas fa-stop text-xl"></i>
                                </button>
                                <div id="rec-timer" class="font-mono text-red-400 text-4xl font-black tracking-wider">00:00</div>
                            </div>
                            <canvas id="rec-visualizer" width="200" height="40" class="opacity-90 rounded"></canvas>
                        </div>

                        <!-- Phase B: Review (Listen before save) -->
                        <div id="rec-phase-review" class="hidden flex-col w-full gap-3 py-2">
                            <input type="text" id="rec-title-input" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-red-500 outline-none text-white placeholder-gray-500 font-bold" placeholder="عنوان یادداشت (الزامی)">
                            
                            <textarea id="rec-subject-input" rows="3" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-red-500 outline-none text-white placeholder-gray-500" placeholder="موضوع یادداشت (اختیاری)"></textarea>

                            <div class="flex items-center gap-3 bg-gray-900/50 p-2 rounded-lg border border-gray-700">
                                <button id="preview-play-btn" onclick="recorder.togglePreview()" class="w-10 h-10 flex-shrink-0 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm hover:bg-blue-500 transition-colors">
                                    <i class="fas fa-play"></i>
                                </button>
                                <div class="flex-1 h-1.5 bg-gray-700 rounded-full overflow-hidden cursor-pointer relative" onclick="recorder.seekPreview(event)">
                                    <div id="preview-bar" class="h-full bg-blue-500 w-0 transition-all duration-100"></div>
                                </div>
                                <span id="preview-time" class="text-xs font-mono text-gray-400 w-10 text-center">00:00</span>
                            </div>
                            
                            <div class="flex gap-2 w-full mt-2">
                                <button onclick="recorder.save()" class="flex-1 bg-green-600 hover:bg-green-500 text-white py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-colors shadow-md shadow-green-900/30">
                                    <i class="fas fa-check"></i> ذخیره یادداشت
                                </button>
                                <button onclick="recorder.discard()" class="flex-1 bg-gray-700 hover:bg-red-900/50 text-gray-300 hover:text-red-400 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-colors">
                                    <i class="fas fa-trash"></i> لغو
                                </button>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Search -->
                <div class="relative mb-4 group">
                    <i class="fas fa-search absolute right-3 top-2.5 text-gray-500 text-xs group-focus-within:text-blue-400 transition-colors"></i>
                    <input type="text" id="search-box" placeholder="جستجو در فعالیت‌ها..." class="w-full bg-gray-900 border border-gray-800 rounded-lg py-2 pr-9 pl-2 text-sm focus:border-blue-500 outline-none text-gray-300 transition-colors">
                </div>

                <!-- Logs List -->
                <div id="logs-list" class="space-y-3">
                    <!-- Logs injected via JS -->
                </div>
                
                <div id="empty-state" class="hidden flex flex-col items-center justify-center py-12 text-gray-600 opacity-50">
                    <i class="fas fa-feather-alt text-4xl mb-2"></i>
                    <p class="text-sm">هنوز فعالیتی ثبت نشده</p>
                </div>
            </div>
            
        </main>

        <!-- Core Audio Element (for timeline playback) -->
        <audio id="audio-core"></audio>

    </div>

    <script>
        // --- Config & Database ---
        const DB_NAME = 'ChronoInfinityDB';
        const DB_STORE = 'audio_blobs';
        
        const state = {
            logs: JSON.parse(localStorage.getItem('chrono_logs')) || [],
            rec: { 
                instance: null, 
                chunks: [], 
                startTime: null, 
                timerInt: null, 
                blob: null, 
                previewUrl: null,
                previewAudio: null 
            },
            filter: ''
        };

        // IndexedDB Helper
        const idb = {
            db: null,
            init() {
                return new Promise((resolve) => {
                    const req = indexedDB.open(DB_NAME, 1);
                    req.onupgradeneeded = e => e.target.result.createObjectStore(DB_STORE);
                    req.onsuccess = e => { this.db = e.target.result; resolve(); };
                });
            },
            put(id, blob) {
                return new Promise((resolve) => {
                    const tx = this.db.transaction(DB_STORE, 'readwrite');
                    tx.objectStore(DB_STORE).put(blob, id);
                    tx.oncomplete = resolve;
                });
            },
            get(id) {
                return new Promise((resolve) => {
                    const tx = this.db.transaction(DB_STORE, 'readonly');
                    const req = tx.objectStore(DB_STORE).get(id);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => resolve(null);
                });
            },
            delete(id) {
                const tx = this.db.transaction(DB_STORE, 'readwrite');
                tx.objectStore(DB_STORE).delete(id);
            }
        };

        // --- Recorder Logic (Refined UI Flow) ---
        const recorder = {
            els: {
                standard: document.getElementById('input-standard'),
                interface: document.getElementById('input-recording'),
                phaseActive: document.getElementById('rec-phase-active'),
                phaseReview: document.getElementById('rec-phase-review'),
                timer: document.getElementById('rec-timer'),
                canvas: document.getElementById('rec-visualizer'),
                previewPlayBtn: document.getElementById('preview-play-btn'),
                previewBar: document.getElementById('preview-bar'),
                previewTime: document.getElementById('preview-time'),
                titleInput: document.getElementById('rec-title-input'),
                subjectInput: document.getElementById('rec-subject-input')
            },
            
            async initUI() {
                // Switch to Recording UI
                this.els.standard.classList.remove('visible-mode');
                this.els.standard.classList.add('hidden-mode');
                
                this.els.interface.classList.remove('hidden-mode');
                this.els.interface.classList.add('visible-mode');
                
                this.els.phaseActive.classList.remove('hidden');
                this.els.phaseReview.classList.add('hidden');
                this.start();
            },

            async start() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    state.rec.chunks = [];
                    state.rec.instance = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' }); 
                    
                    state.rec.instance.ondataavailable = e => state.rec.chunks.push(e.data);
                    state.rec.instance.onstop = () => {
                        state.rec.blob = new Blob(state.rec.chunks, { type: 'audio/webm' });
                        state.rec.previewUrl = URL.createObjectURL(state.rec.blob);
                        stream.getTracks().forEach(t => t.stop());
                        this.uiToReview();
                    };

                    state.rec.instance.start();
                    state.rec.startTime = Date.now();
                    this.visualize(stream);
                    
                    state.rec.timerInt = setInterval(() => {
                        const s = Math.floor((Date.now() - state.rec.startTime) / 1000);
                        const m = Math.floor(s / 60).toString().padStart(2, '0');
                        const sec = (s % 60).toString().padStart(2, '0');
                        this.els.timer.innerText = `${m}:${sec}`;
                    }, 1000);

                } catch (e) {
                    ui.toast('عدم دسترسی به میکروفون', 'err');
                    this.discard();
                }
            },

            stop() {
                if (state.rec.instance) state.rec.instance.stop();
                clearInterval(state.rec.timerInt);
            },

            uiToReview() {
                this.els.phaseActive.classList.add('hidden');
                this.els.phaseReview.classList.remove('hidden');
                this.els.phaseReview.classList.add('flex');
                
                if (state.rec.previewAudio) {
                    state.rec.previewAudio.pause();
                    state.rec.previewAudio.src = '';
                }
                state.rec.previewAudio = new Audio(state.rec.previewUrl);
                this.els.titleInput.value = 'یادداشت صوتی ' + new Date().toLocaleTimeString('fa-IR');
                this.els.subjectInput.value = ''; // Clear subject

                const aud = state.rec.previewAudio;
                
                aud.onloadedmetadata = () => {
                     const s = Math.floor(aud.duration % 60).toString().padStart(2, '0');
                     const m = Math.floor(aud.duration / 60).toString().padStart(2, '0');
                     this.els.previewTime.innerText = `${m}:${s}`;
                };
                
                aud.ontimeupdate = () => {
                    const pct = (aud.currentTime / aud.duration) * 100;
                    this.els.previewBar.style.width = `${pct}%`;
                    const s = Math.floor(aud.currentTime % 60).toString().padStart(2, '0');
                    const m = Math.floor(aud.currentTime / 60).toString().padStart(2, '0');
                    this.els.previewTime.innerText = `${m}:${s}`;
                };

                aud.onended = () => {
                    this.els.previewPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
                    this.els.previewBar.style.width = '0%';
                };
            },

            togglePreview() {
                const aud = state.rec.previewAudio;
                if (!aud) return;
                
                if (aud.paused) {
                    aud.play();
                    this.els.previewPlayBtn.innerHTML = '<i class="fas fa-pause"></i>';
                } else {
                    aud.pause();
                    this.els.previewPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
                }
            },

            seekPreview(event) {
                const aud = state.rec.previewAudio;
                if (!aud) return;

                const bar = event.currentTarget;
                const rect = bar.getBoundingClientRect();
                const clickX = event.clientX - rect.left;
                const pct = clickX / rect.width;
                aud.currentTime = aud.duration * pct;
            },

            save() {
                const title = this.els.titleInput.value.trim();
                const subject = this.els.subjectInput.value.trim();
                
                if (!title) {
                    this.els.titleInput.focus();
                    this.els.titleInput.classList.add('border-red-500');
                    return ui.toast('لطفاً عنوان یادداشت را وارد کنید', 'err');
                }
                this.els.titleInput.classList.remove('border-red-500');
                data.addLog('audio', { title, subject });
            },

            discard() {
                if(state.rec.previewAudio) {
                    state.rec.previewAudio.pause();
                    state.rec.previewAudio.src = '';
                }
                state.rec.blob = null;
                state.rec.previewUrl = null;
                state.rec.previewAudio = null;
                
                // Revert UI
                this.els.interface.classList.add('hidden-mode');
                this.els.interface.classList.remove('visible-mode');
                
                this.els.standard.classList.add('visible-mode');
                this.els.standard.classList.remove('hidden-mode');

                this.els.timer.innerText = "00:00";
                this.els.titleInput.value = '';
                this.els.subjectInput.value = '';
            },

            visualize(stream) {
                const ctx = this.els.canvas.getContext('2d');
                const audioCtx = new AudioContext();
                const src = audioCtx.createMediaStreamSource(stream);
                const analyser = audioCtx.createAnalyser();
                src.connect(analyser);
                analyser.fftSize = 64;
                const buffer = analyser.frequencyBinCount;
                const data = new Uint8Array(buffer);

                const draw = () => {
                    if (!state.rec.instance || state.rec.instance.state !== 'recording') {
                        audioCtx.close();
                        return;
                    }
                    requestAnimationFrame(draw);
                    analyser.getByteFrequencyData(data);
                    ctx.clearRect(0, 0, 200, 40);
                    
                    const barW = 200 / buffer;
                    for(let i=0; i<buffer; i++) {
                        const h = (data[i] / 255) * 40;
                        ctx.fillStyle = `rgba(248, 113, 113, ${data[i]/255})`;
                        ctx.fillRect(i * barW, 20 - h/2, barW-1, h);
                    }
                };
                draw();
            }
        };

        // --- Data & Logic (UPDATED) ---
        const data = {
            async addLog(type, audioData = null) {
                const cat = document.getElementById('cat-input').value;
                const input = document.getElementById('task-input'); // Title input for text
                const subjectInput = document.getElementById('subject-input'); // Subject input for text
                
                let text = ''; // This will be the Title
                let subject = ''; // This will be the Subject

                if (type === 'audio') {
                    text = audioData.title;
                    subject = audioData.subject;
                } else {
                    // type === 'text'
                    text = input.value.trim();
                    subject = subjectInput.value.trim(); // Get subject from text textarea
                    
                    if (!text) {
                        input.focus();
                        input.classList.add('border-red-500');
                        return ui.toast('لطفاً عنوان را وارد کنید', 'err');
                    }
                    input.classList.remove('border-red-500');
                }
                
                const id = Date.now();
                const log = {
                    id,
                    type,
                    cat,
                    text, // Title
                    subject, // Subject (can be empty string)
                    time: new Date().toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit'}),
                    ts: id
                };

                if (type === 'audio') {
                    await idb.put(id, state.rec.blob);
                    recorder.discard();
                }

                state.logs.unshift(log);
                this.save();
                render.list();
                
                // Clear text inputs
                input.value = '';
                subjectInput.value = ''; // Clear text subject
                
                ui.toast('فعالیت ثبت شد');
            },

            delete(id) {
                // if(!confirm('این فعالیت حذف شود؟')) return; 
                const idx = state.logs.findIndex(l => l.id === id);
                if (idx === -1) return;
                
                if (state.logs[idx].type === 'audio') {
                    idb.delete(id);
                }
                state.logs.splice(idx, 1);
                this.save();
                render.list();
            },

            save() {
                localStorage.setItem('chrono_logs', JSON.stringify(state.logs));
            }
        };

        // --- Backup ---
        const backupManager = {
            async exportZip() {
                ui.toast('درحال فشرده‌سازی اطلاعات...');
                const zip = new JSZip();
                zip.file("data.json", JSON.stringify(state.logs));
                
                const audioLogs = state.logs.filter(l => l.type === 'audio');
                if (audioLogs.length > 0) {
                    const folder = zip.folder("audio");
                    for (const log of audioLogs) {
                        const blob = await idb.get(log.id);
                        if (blob) folder.file(`${log.id}.webm`, blob);
                    }
                }

                zip.generateAsync({type:"blob"}).then(content => {
                    saveAs(content, `ChronoBackup_${new Date().toISOString().slice(0,10)}.zip`);
                    ui.toast('فایل پشتیبان دانلود شد');
                });
            },

            async importZip(input) {
                const file = input.files[0];
                if (!file) return;
                ui.toast('درحال بازگردانی...');
                
                try {
                    const zip = await JSZip.loadAsync(file);
                    const jsonStr = await zip.file("data.json").async("string");
                    const newLogs = JSON.parse(jsonStr);
                    
                    const audioFolder = zip.folder("audio");
                    if (audioFolder) {
                        const promises = [];
                        audioFolder.forEach((path, file) => {
                            promises.push(async () => {
                                const blob = await file.async("blob");
                                const id = parseInt(path.replace('.webm', ''));
                                await idb.put(id, blob);
                            });
                        });
                        for(let p of promises) await p();
                    }

                    const currentIds = new Set(state.logs.map(l => l.id));
                    const uniqueNew = newLogs.filter(l => !currentIds.has(l.id));
                    state.logs = [...uniqueNew, ...state.logs].sort((a,b) => b.ts - a.ts);
                    
                    data.save();
                    render.list();
                    ui.toast('بازیابی با موفقیت انجام شد');
                } catch (e) {
                    console.error(e);
                    ui.toast('فایل نامعتبر است', 'err');
                }
                input.value = '';
            }
        };

        // --- UI & Render ---
        const ui = {
            toast(msg, type='info') {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                t.classList.remove('-translate-y-24');
                setTimeout(() => t.classList.add('-translate-y-24'), 3000);
            }
        };

        const render = {
            list() {
                const container = document.getElementById('logs-list');
                const filterText = document.getElementById('search-box').value.toLowerCase();
                container.innerHTML = '';
                
                const filtered = state.logs.filter(l => 
                    l.text.toLowerCase().includes(filterText) || 
                    (l.subject && l.subject.toLowerCase().includes(filterText))
                );

                if (filtered.length === 0) {
                    document.getElementById('empty-state').classList.remove('hidden');
                    return;
                }
                document.getElementById('empty-state').classList.add('hidden');

                const cats = { work: 'bg-blue-500', study: 'bg-purple-500', break: 'bg-green-500', sport: 'bg-orange-500' };

                filtered.forEach(log => {
                    const isAudio = log.type === 'audio';
                    const el = document.createElement('div');
                    el.className = 'bg-gray-800/60 border border-gray-700/50 rounded-xl p-3 relative group hover:bg-gray-800 transition-colors';
                    
                    // Add click handler if subject exists (and is not empty)
                    if (log.subject) {
                        el.setAttribute('onclick', `render.toggleSubject(${log.id})`);
                        el.classList.add('cursor-pointer');
                    }

                    let playerHtml = '';
                    if (isAudio) {
                        playerHtml = `
                            <div class="mt-2 bg-gray-900/50 rounded-lg p-2 flex items-center gap-2" id="player-${log.id}">
                                <button onclick="player.play(${log.id}); event.stopPropagation();" class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-xs hover:bg-blue-500 transition-colors flex-shrink-0">
                                    <i class="fas fa-play"></i>
                                </button>
                                <div class="flex-1 h-1.5 bg-gray-700 rounded-full overflow-hidden cursor-pointer relative" onclick="player.seek(event, ${log.id}); event.stopPropagation();">
                                    <div class="h-full bg-blue-500 w-0 transition-all duration-200" id="prog-${log.id}"></div>
                                </div>
                                <button onclick="player.speed(${log.id}); event.stopPropagation();" class="text-[10px] font-bold text-gray-500 w-6 hover:text-gray-300 flex-shrink-0" id="spd-${log.id}">1x</button>
                            </div>
                        `;
                    }

                    el.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-3 min-w-0"> <!-- for truncation -->
                                <div class="w-1.5 h-8 rounded-full ${cats[log.cat] || 'bg-gray-500'} flex-shrink-0"></div>
                                <div class="min-w-0">
                                    <p class="text-gray-200 text-sm font-medium truncate">${log.text}</p> <!-- Title -->
                                    <div class="flex items-center gap-2 text-[10px] text-gray-500 mt-1">
                                        <span>${log.time}</span>
                                        <span class="bg-gray-700 px-1.5 rounded text-gray-400">${log.cat}</span>
                                    </div>
                                </div>
                            </div>
                            <button onclick="data.delete(${log.id}); event.stopPropagation();" class="text-gray-600 hover:text-red-500 transition-colors p-1 flex-shrink-0 z-10 relative">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        
                        <!-- Subject (hidden by default) -->
                        ${log.subject ? `<p id="subject-${log.id}" class="text-gray-400 text-sm mt-2 pt-2 border-t border-gray-700/50 hidden whitespace-pre-wrap break-words">${log.subject}</p>` : ''}
                        
                        ${playerHtml}
                    `;
                    container.appendChild(el);
                });
            },

            toggleSubject(id) {
                const subjectEl = document.getElementById(`subject-${id}`);
                if (subjectEl) {
                    subjectEl.classList.toggle('hidden');
                }
            }
        };

        // --- Player (Global Audio Core) ---
        const player = {
            audio: document.getElementById('audio-core'),
            currentId: null,
            speedVal: 1,
            
            async play(id) {
                const btn = document.querySelector(`#player-${id} button i`);
                if (!btn) return;
                
                if (this.currentId === id && !this.audio.paused) {
                    this.audio.pause();
                    btn.className = 'fas fa-play';
                    return;
                }

                if (this.currentId) {
                    const oldBtn = document.querySelector(`#player-${this.currentId} button i`);
                    if (oldBtn) oldBtn.className = 'fas fa-play';
                    const oldBar = document.getElementById(`prog-${this.currentId}`);
                    if (oldBar) oldBar.style.width = '0%';
                }

                const blob = await idb.get(id);
                if (!blob) return ui.toast('فایل صوتی یافت نشد', 'err');
                
                this.audio.pause();
                this.audio.src = '';
                
                this.audio.src = URL.createObjectURL(blob);
                this.audio.playbackRate = this.speedVal;
                this.currentId = id;
                
                try {
                    await this.audio.play();
                    btn.className = 'fas fa-pause';
                } catch (err) {
                    console.error("Audio play failed:", err);
                    btn.className = 'fas fa-play';
                }

                this.audio.ontimeupdate = () => {
                    if (this.currentId !== id) return;
                    const pct = (this.audio.currentTime / this.audio.duration) * 100;
                    const bar = document.getElementById(`prog-${id}`);
                    if (bar) bar.style.width = `${pct}%`;
                };
                
                this.audio.onended = () => {
                    if (this.currentId === id) {
                        btn.className = 'fas fa-play';
                        const bar = document.getElementById(`prog-${id}`);
                        if (bar) bar.style.width = '0%';
                        this.currentId = null;
                    }
                };
            },
            
            seek(event, id) {
                const bar = event.currentTarget;
                const rect = bar.getBoundingClientRect();
                const clickX = event.clientX - rect.left;
                const pct = clickX / rect.width;
                
                if (id === this.currentId && !this.audio.paused) {
                    this.audio.currentTime = this.audio.duration * pct;
                } else {
                    this.play(id).then(() => {
                        if(this.audio.duration) {
                            this.audio.currentTime = this.audio.duration * pct;
                        }
                        this.audio.pause();
                        document.querySelector(`#player-${id} button i`).className = 'fas fa-play';
                    });
                }
            },

            speed(id) {
                const speeds = [1, 1.5, 2];
                let idx = speeds.indexOf(this.speedVal);
                this.speedVal = speeds[(idx + 1) % speeds.length];
                
                document.querySelectorAll('button[id^="spd-"]').forEach(btn => {
                    btn.innerText = this.speedVal + 'x';
                });
                
                this.audio.playbackRate = this.speedVal;
            }
        };

        // --- Init ---
        window.addEventListener('DOMContentLoaded', async () => {
            await idb.init();
            document.getElementById('search-box').addEventListener('input', render.list);
            render.list();
        });

    </script>
</body>
</html>


